name: Monthly Lockdown Label

on:
    schedule:
        # Runs on the third Tuesday of every month at 00:00 UTC
        - cron: "0 0 15-21 * 2"
    pull_request_target:
        types: [opened, reopened, synchronize, edited]

permissions:
    contents: read
    pull-requests: write

jobs:
    add-lockdown-label:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: (scheduled) Add Branch Lockdown label to PRs
              id: add_label_scheduled
              if: github.event_name == 'schedule'
              uses: actions/github-script@v6
              with:
                    script: |
                        const { data: prs } = await github.pulls.list({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            state: 'open',
                            per_page: 300,
                        });
                        
                        const filtered_prs = prs.filter(pr => pr.base.ref.startsWith('release/8') || pr.base.ref.startsWith('release/9'));

                        for (const pr of filtered_prs) {
                            await github.pulls.addLabels({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                pull_number: pr.number,
                                labels: ['Branch Lockdown'],
                            });
                        }

            - name: (PR) Check if date is within range
              id: check_date_pr
              if: github.event_name == 'pull_request_target'
              run: |
                # Set chron expression to check if the current date is between the third Tuesday of the month and the first Tuesday of the month
                CRON_START="0 0 15-21 * 2"
                CRON_END="0 0 1-7 * 2"
                CURRENT_DATE=$(date +%Y-%m-%d)
                # If the current date is between CRON_START and CRON_END, set the output to true
                if [[ $(date -d "$CURRENT_DATE" +%s) -ge $(date -d "$CRON_START" +%s) && $(date -d "$CURRENT_DATE" +%s) -le $(date -d "$CRON_END" +%s) ]]; then
                    echo "Within the date range. Setting output to true."
                    echo "::set-output name=within_range::true"
                else
                    echo "Outside the date range. Setting output to false."
                    echo "::set-output name=within_range::false"
                fi

            - name: (PR) Add Branch Lockdown label to PRs
              id: add_label_pr
              if: github.event_name == 'pull_request_target' && steps.check_date_pr.outputs.within_range == 'true'
              uses: actions/github-script@v6
              with:
                    script: |
                        const pr = context.payload.pull_request;

                        if (pr.base.ref.startsWith('release/8') || pr.base.ref.startsWith('release/9')) {
                            // Add the Branch Lockdown label to the PR
                        
                            await github.pulls.addLabels({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                pull_number: pr.number,
                                labels: ['Branch Lockdown'],
                            });
                        } 
                            