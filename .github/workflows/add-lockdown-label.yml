name: Add Branch Lockdown Label to PRs

on:
  pull_request:
    branches-ignore:
      - main
      - release/9.0.3xx
  workflow_dispatch: # Allows manual triggering of the workflow

permissions:
  actions: write # For managing the operation state cache
  issues: write

jobs:
  add-label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Add label to PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the third Tuesday of the current month
          third_tuesday=$(date -d "$(date +%Y-%m-01) +14 days" +%Y-%m-%d)
          while [ $(date -d "$third_tuesday" +%u) -ne 2 ]; do
            third_tuesday=$(date -d "$third_tuesday + 1 day" +%Y-%m-%d)
          done
          
          # Determine the first Tuesday of the current month
          first_tuesday=$(date -d "$(date +%Y-%m-01)" +%Y-%m-%d)
          while [ $(date -d "$first_tuesday" +%u) -ne 2 ]; do
            first_tuesday=$(date -d "$first_tuesday + 1 day" +%Y-%m-%d)
          done

          # Get current date
          current_date=$(date +%Y-%m-%d)

          echo "Current Date: $current_date"
          echo "Third Tuesday of the month: $third_tuesday"
          echo "First Tuesday of the month: $first_tuesday"

          # Check if the current date is after the third Tuesday of this month or before the first Tuesday of this month
          if [[ "$current_date" > "$third_tuesday" || "$current_date" < "$first_tuesday" ]]; then
            echo "Within the label period. Adding labels to PRs..."

            # List of known branches
            known_branches=("release/8.*" "release/9.*")
            exclude_branch="release/9.0.3xx"

            # Get the target branch of the PR
            pr_branch="${{ github.event.pull_request.base.ref }}"

            # Check if the PR branch is in the list of known branches and not the excluded branch, and if the current date is within the specified range
            for branch in "${known_branches[@]}"; do
              if [[ "$pr_branch" =~ $branch && "$pr_branch" != "$exclude_branch" && "$current_date" > "$start_date" && "$current_date" < "$end_date" ]]; then
                echo "Adding Branch Lockdown label to PR #${{ github.event.pull_request.number }} targeting branch $pr_branch"
                gh pr edit ${{ github.event.pull_request.number }} --add-label "Branch Lockdown"
                break
              fi
          done
          else
            echo "Outside the label period. No labels added."
          fi
