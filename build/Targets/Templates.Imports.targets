<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Copyright (c)  Microsoft.  All Rights Reserved.  Licensed under the Apache License, Version 2.0.  See License.txt in the project root for license information. -->

  <!-- Workaround: See: #https://github.com/dotnet/roslyn-project-system/issues/292 -->
  <Target Name="_CopySharedTemplateFiles" BeforeTargets="GetZipFilesFromVSTemplates" Inputs="@(SharedTemplateFiles)" Outputs="%(SharedTemplateFiles.TargetPath)">
    <Copy SourceFiles="@(SharedTemplateFiles)" DestinationFiles="%(SharedTemplateFiles.TargetPath)" OverwriteReadOnlyFiles="true">
      <Output TaskParameter="CopiedFiles" ItemName="FileWrites" />
    </Copy>
  </Target>
  
  <!-- Project templates reference the Microsoft.NET.Sdk package produced in this project.
       The following Custom Inline Task and Target write version number associated with this build
       into the project json template associated with the project template.
    -->

  <!-- RewriteToken Task: Reads a template and writes to a rewrite path with token replaced  -->
  <UsingTask TaskName="RewriteToken" 
    TaskFactory="CodeTaskFactory" 
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v12.0.dll">
    
    <ParameterGroup>
      <TemplatePath ParameterType="System.String" Required="true" />
      <RewritePath  ParameterType="System.String" Required="true" />
      <Token        ParameterType="System.String" Required="true" />
      <Replacement  ParameterType="System.String" Required="true" />
    </ParameterGroup>

    <Task>
      <Code Type="Fragment" Language="cs"><![CDATA[
        string content = File.ReadAllText(TemplatePath);
        content = content.Replace(Token, Replacement);
        File.WriteAllText(RewritePath, content);
      ]]></Code>
    </Task>
  </UsingTask>

  <!-- _UpdateNETCoreSdkVersionForProjectJson Target: produce project json template with current build version -->
  <Target Name="_UpdateNETCoreSdkVersionForProjectJson" BeforeTargets="GetZipFilesFromVSTemplates" 
    Inputs="@(ProjectJsonTemplate)" Outputs="%(ProjectJsonTemplate.TargetPath)">

    <RewriteToken 
      TemplatePath="@(ProjectJsonTemplate)" 
      RewritePath="%(ProjectJsonTemplate.TargetPath)"
      Token="$$buildversion$$" 
      Replacement="$(Version)"/>

  </Target>

  <!-- _UpdateNETCoreSdkVersion Target: produce project template with current build version -->
  <Target Name="_UpdateNETCoreSdkVersion" BeforeTargets="GetZipFilesFromVSTemplates" 
    Inputs="@(ProjectTemplate)" Outputs="%(ProjectTemplate.TargetPath)">

    <RewriteToken 
      TemplatePath="@(ProjectTemplate)" 
      RewritePath="%(ProjectTemplate.TargetPath)"
      Token="$$buildversion$$" 
      Replacement="$(Version)"/>

  </Target>

  <!-- RewriteToken Task: Deletes all lines from a file that contain the specified string  -->
  <UsingTask TaskName="DeleteLinesFromFile"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v12.0.dll">
    <ParameterGroup>
      <FilePath ParameterType="System.String" Required="true" />
      <LineContents ParameterType="System.String" Required="true" />
    </ParameterGroup>
      
    <Task>
      <Code Type="Fragment" Language="cs"><![CDATA[
        string[] lines = File.ReadAllLines(FilePath);
        System.Text.StringBuilder content = new StringBuilder();
        foreach (string line in lines)
        {
            if (!line.Contains(LineContents))
            {
                content.AppendLine(line);
            }
        }
        File.WriteAllText(FilePath, content.ToString());
      ]]></Code>
    </Task>
  </UsingTask>
    
  <!-- _RestoreTemplateProject Target: Run "dotnet restore" on the project file to create the project.assets.json,
        then remove the "packageFolders" value from the file (as that is machine-specific). -->
  <Target Name="_RestoreTemplateProject" BeforeTargets="GetZipFilesFromVSTemplates" DependsOnTargets="_UpdateNETCoreSdkVersion">
      <PropertyGroup>
        <__NewLine><![CDATA[
]]></__NewLine>
        <__SetMSBuildSdksPath>set MSBuildSDKsPath=$(RepositoryRootDirectory)bin\$(Configuration)\Sdks</__SetMSBuildSdksPath>
    </PropertyGroup>
    
    <Exec Command="$(__SetMSBuildSdksPath)$(__NewLine)$(DotNetTool) restore %(ProjectTemplate.TargetPath)" />

    <PropertyGroup>
      <_PackagesFolderToReplace>$(NUGET_PACKAGES)</_PackagesFolderToReplace>
      <_PackagesFolderToReplace>$(_PackagesFolderToReplace.Replace('\', '\\'))</_PackagesFolderToReplace>
      <_TemplateProjectAssetsFile>$(MSBuildProjectDirectory)\obj\project.assets.json</_TemplateProjectAssetsFile>
    </PropertyGroup>
      <DeleteLinesFromFile 
        FilePath="$(_TemplateProjectAssetsFile)"
        LineContents="$(_PackagesFolderToReplace)"
        Condition="Exists($(_TemplateProjectAssetsFile))"
        />
  </Target>

  <!-- Returns the current build version. Used in .vsixmanifests to substitute our build version into them -->
  <Target Name="GetBuildVersion" Outputs="$(VsixVersion)" />

  <PropertyGroup>
    <DeployExtension>false</DeployExtension>
    <NoWarn>$(NoWarn);2008</NoWarn>
  </PropertyGroup>

  <Import Project="$(VsSDKInstall)\Microsoft.VsSDK.targets" Condition="'$(VsSDKInstall)' != ''" />
  <Import Project="Signing.Imports.targets"/>

</Project>