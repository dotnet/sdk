parameters:
  variables: {}
  oneESCompat:
    # jobTemplatePath: /eng/common/templates/job/job.yml
    templateFolderName: templates
    publishTaskName: PublishBuildArtifacts@1
  container: ''
  categoryName: Build
  runTests: true
  testProjects: $(Build.SourcesDirectory)/test/UnitTests.proj
  ### ENV VARS ###
  testFullMSBuild: false
  runAoTTests: false
  ### MSBUILD ###
  buildArchitecture: x64
  publishArgument: ''
  signArgument: ''
  runTestsAsTool: false
  pgoInstrument: false
  runtimeIdentifier: linux-x64
  osProperties: ''
  runtimeSourceProperties: ''
  officialBuildProperties: ''

jobs:
- template: /eng/common/${{ parameters.oneESCompat.templateFolderName }}/job/job.yml
  parameters:
    ${{ if eq(parameters.container, '') }}:
      name: ${{ parameters.categoryName }}_${{ parameters.pool.os }}_${{ parameters.buildArchitecture }}
      displayName: '${{ parameters.categoryName }}: ${{ parameters.pool.os }} (${{ parameters.buildArchitecture }})'
    ${{ else }}:
      name: ${{ parameters.categoryName }}_${{ parameters.pool.os }}_${{ parameters.buildArchitecture }}_${{ parameters.container }}
      displayName: '${{ parameters.categoryName }}: ${{ parameters.pool.os }} (${{ parameters.buildArchitecture }}) [${{ parameters.container }}]'
    pool: ${{ parameters.pool }}
    container: ${{ parameters.container }}
    strategy: ${{ parameters.strategy }}
    helixRepo: dotnet/sdk
    timeoutInMinutes: 180
    enableMicrobuild: true
    enablePublishBuildAssets: true
    enableTelemetry: true
    enablePublishUsingPipelines: true
    variables:
    - ${{ insert }}: ${{ parameters.variables }}

    steps:
    ############## PREP ###############
    - ${{ if ne(variables['System.TeamProject'], 'public') }}:
      - ${{ if eq(parameters.pool.os, 'windows') }}:
        - powershell: $(Build.SourcesDirectory)/eng/common/SetupNugetSources.ps1 -ConfigFile $(Build.SourcesDirectory)/NuGet.config -Password $Env:Token
          displayName: Setup Private Feeds Credentials
          env:
            Token: $(dn-bot-dnceng-artifact-feeds-rw)
      # The PowerShell script above would work fine on Linux/Mac, but the Linux containers don't have PowerShell installed.
      - ${{ else }}:
        - script: . $(Build.SourcesDirectory)/eng/common/SetupNugetSources.sh $(Build.SourcesDirectory)/NuGet.config $Token
          displayName: Setup Private Feeds Credentials
          env:
            Token: $(dn-bot-dnceng-artifact-feeds-rw)

    ############### BUILDING ###############
    - ${{ if eq(parameters.pool.os, 'windows') }}:
      - powershell: eng/common/build.ps1
          -restore -build -pack -ci -nativeToolsOnMachine
          -configuration $(buildConfiguration)
          ${{ parameters.publishArgument }}
          ${{ parameters.signArgument }}
          /p:Architecture=${{ parameters.buildArchitecture }}
          /p:RunTestsAsTool=${{ parameters.runTestsAsTool }}
          /p:PgoInstrument=${{ parameters.pgoInstrument }}
          ${{ parameters.runtimeSourceProperties }}
          ${{ parameters.officialBuildProperties }}
          /p:DotNetSignType=$(_SignType) /p:TeamName=$(_TeamName)
        displayName: Build
        env:
          # Required by Arcade for passing to Helix
          # SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          # HelixAccessToken: $(HelixApiAccessToken)
          BuildConfig: $(buildConfiguration)
          TestFullMSBuild: ${{ parameters.testFullMSBuild }}
    - ${{ else }}:
      - script: |
          source $(Build.SourcesDirectory)/eng/common/native/init-os-and-arch.sh
          source $(Build.SourcesDirectory)/eng/common/native/init-distro-rid.sh
          initDistroRidGlobal "$os" "$arch" ""

          . $(Build.SourcesDirectory)/eng/common/build.sh \
          -restore -build -pack -ci \
          -configuration $(buildConfiguration) \
          ${{ parameters.publishArgument }} \
          ${{ parameters.signArgument }} \
          /p:Architecture=${{ parameters.buildArchitecture }} \
          /p:RunTestsAsTool=${{ parameters.runTestsAsTool }} \
          /p:PgoInstrument=${{ parameters.pgoInstrument }} \
          /p:Rid=${{ parameters.runtimeIdentifier }} \
          ${{ parameters.osProperties }} \
          ${{ parameters.runtimeSourceProperties }} \
          ${{ parameters.officialBuildProperties }} \
          /p:DotNetSignType=$(_SignType) /p:TeamName=$(_TeamName)
        displayName: Build
        env:
          # Required by Arcade for passing to Helix
          # SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          # HelixAccessToken: $(HelixApiAccessToken)
          BuildConfig: $(buildConfiguration)
          TestFullMSBuild: ${{ parameters.testFullMSBuild }}

    ############### TESTING ###############
    - ${{ if eq(parameters.runTests, true) }}:
      - ${{ if eq(parameters.runAoTTests, true) }}:
        # For the reason this is here, see: https://github.com/dotnet/sdk/issues/22655
        - script: $(Build.SourcesDirectory)/artifacts/bin/redist/$(_BuildConfig)/dotnet/dotnet workload install wasm-tools --skip-manifest-update
          displayName: Install wasm-tools Workload
      - ${{ if eq(parameters.pool.os, 'windows') }}:
        # TODO: Change _CustomHelixTargetQueue name
        - powershell: eng/common/build.ps1
            -restore -test -ci -prepareMachine -nativeToolsOnMachine
            -configuration $(buildConfiguration)
            -projects ${{ parameters.testProjects }}
            /p:Architecture=${{ parameters.buildArchitecture }}
            ${{ parameters.runtimeSourceProperties }}
            /p:_CustomHelixTargetQueue=${{ parameters.helixTargetQueue }}
            /bl:$(Build.SourcesDirectory)/artifacts/log/$(buildConfiguration)/${{ parameters.categoryName }}Tests.binlog
          displayName: Run ${{ parameters.categoryName }} Tests
          condition: succeeded()
          env:
            # Required by Arcade for running in Helix.
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)
            HelixAccessToken: $(HelixApiAccessToken)
            RunAoTTests: ${{ parameters.runAoTTests }}
      - ${{ else }}:
        - script: eng/common/build.sh
            -restore -test -ci -prepareMachine
            -configuration $(buildConfiguration)
            -projects ${{ parameters.testProjects }}
            /p:Architecture=${{ parameters.buildArchitecture }}
            /p:Rid=${{ parameters.runtimeIdentifier }}
            ${{ parameters.osProperties }}
            ${{ parameters.runtimeSourceProperties }}
            /p:_CustomHelixTargetQueue=${{ parameters.helixTargetQueue }}
            /bl:$(Build.SourcesDirectory)/artifacts/log/$(buildConfiguration)/${{ parameters.categoryName }}Tests.binlog
          displayName: Run ${{ parameters.categoryName }} Tests
          condition: succeeded()
          env:
            # Required by Arcade for running in Helix.
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)
            HelixAccessToken: $(HelixApiAccessToken)
            RunAoTTests: ${{ parameters.runAoTTests }}

    ############### POST ###############
    - task: CopyFiles@2
      displayName: Copy Logs
      inputs:
        SourceFolder: $(Build.SourcesDirectory)/artifacts
        ${{ if eq(parameters.runTests, false) }}:
          Contents: |
            log/$(buildConfiguration)/**/*
            TestResults/$(buildConfiguration)/**/*
            SymStore/$(buildConfiguration)/**/*
            tmp/$(buildConfiguration)/**/*.binlog
        ${{ else }}:
          Contents: |
            log/$(buildConfiguration)/**/*
            TestResults/$(buildConfiguration)/**/*
            tmp/$(buildConfiguration)/**/*.binlog
        TargetFolder: $(Build.ArtifactStagingDirectory)
      continueOnError: true
      condition: always()

    - task: ${{ parameters.oneESCompat.publishTaskName }}
      displayName: Publish Logs
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
        # TODO: Figure out appropriate artifact name
        # ArtifactName: ${{ parameters.name }}
        ${{ if eq(parameters.container, '') }}:
          ArtifactName: ${{ parameters.categoryName }}_${{ parameters.pool.os }}_${{ parameters.buildArchitecture }}
        ${{ else }}:
          ArtifactName: ${{ parameters.categoryName }}_${{ parameters.pool.os }}_${{ parameters.buildArchitecture }}_${{ parameters.container }}
        publishLocation: Container
      continueOnError: true
      condition: always()
