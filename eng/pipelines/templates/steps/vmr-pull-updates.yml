### These steps synchronize new code from product repositories into the VMR (https://github.com/dotnet/dotnet).
### They initialize the darc CLI and pull the new updates.
### Changes are applied locally onto the already cloned VMR (located in $vmrPath).

parameters:
- name: vmrBranch
  displayName: dotnet/dotnet branch to use
  type: string

- name: targetRef
  displayName: Target revision in dotnet/sdk to synchronize
  type: string
  default: $(Build.SourceVersion)

- name: vmrPath
  displayName: Path where the dotnet/dotnet is checked out to
  type: string
  default: $(Agent.BuildDirectory)/vmr

- name: additionalSyncs
  displayName: Optional list of package names whose repo's source will also be synchronized in the local VMR, e.g. NuGet.Protocol
  type: object
  default: []

steps:
- checkout: self
  displayName: Clone dotnet/sdk
  path: sdk

# This step is needed so that when we get a detached HEAD / shallow clone,
# we still pull the commit into the temporary sdk clone to use it during the sync.
- script: |
    git branch sdk-head
    git rev-parse HEAD
  displayName: Label PR commit
  workingDirectory: $(Agent.BuildDirectory)/sdk

- script: |
    git checkout -B ${{ parameters.vmrBranch }}
    echo "##vso[task.setvariable variable=vmrBranch]${{ parameters.vmrBranch }}"
  displayName: Prepare branch ${{ parameters.vmrBranch }}
  workingDirectory: ${{ parameters.vmrPath }}

- script: |
    git config --global user.name "dotnet-maestro[bot]"
    git config --global user.email "dotnet-maestro[bot]@users.noreply.github.com"
  displayName: Set git author to dotnet-maestro[bot]
  workingDirectory: ${{ parameters.vmrPath }}

- script: |
    ./eng/vmr-sync.sh                         \
      --vmr ${{ parameters.vmrPath }}         \
      --tmp $(Agent.TempDirectory)            \
      --azdev-pat '$(dn-bot-all-orgs-code-r)' \
      --branch ${{ parameters.vmrBranch }}    \
      --ci                                    \
      --debug

    if [ "$?" -ne 0 ]; then
      echo "##vso[task.logissue type=error]Failed to synchronize the VMR"
      exit 1
    fi
  displayName: Synchronize local VMR (Unix)
  condition: ne(variables['Agent.OS'], 'Windows_NT')
  workingDirectory: $(Agent.BuildDirectory)/sdk

- script: |
    git config --global diff.astextplain.textconv echo
    git config --system core.longpaths true
  displayName: Configure Windows git (longpaths, astextplain)
  condition: eq(variables['Agent.OS'], 'Windows_NT')

- powershell: |
    ./eng/vmr-sync.ps1                      `
      -vmr ${{ parameters.vmrPath }}        `
      -tmp $(Agent.TempDirectory)           `
      -azdevPat '$(dn-bot-all-orgs-code-r)' `
      -branch ${{ parameters.vmrBranch }}   `
      -ci                                   `
      -debugOutput

    if ($LASTEXITCODE -ne 0) {
      echo "##vso[task.logissue type=error]Failed to synchronize the VMR"
      exit 1
    }
  displayName: Synchronize local VMR (Windows)
  condition: eq(variables['Agent.OS'], 'Windows_NT')
  workingDirectory: $(Agent.BuildDirectory)/sdk

- ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
  - task: CopyFiles@2
    displayName: Collect failed patches
    condition: failed()
    inputs:
      SourceFolder: '$(Agent.TempDirectory)'
      Contents: '*.patch'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/FailedPatches'

  - publish: '$(Build.ArtifactStagingDirectory)/FailedPatches'
    artifact: $(System.JobDisplayName)_FailedPatches
    displayName: Upload failed patches
    condition: failed()

- ${{ each assetName in parameters.additionalSyncs }}:
  # The vmr-sync script ends up staging files in the local VMR so we have to commit those
  - script:
      git -C commit --allow-empty -am "Forward-flow dotnet/sdk"
    displayName: Commit local VMR changes
    workingDirectory: ${{ parameters.vmrPath }}

  - template: ../steps/install-darc.yml@self
    parameters:
      workingDirectory: $(Agent.BuildDirectory)/sdk

  - script: |
      set -ex

      echo "Searching for details of asset ${{ assetName }}..."

      # Use darc to get dependencies information
      dependencies=$(./.dotnet/dotnet darc get-dependencies --name '${{ assetName }}' --ci)

      # Extract repository URL and commit hash
      repository=$(echo "$dependencies" | grep -oP 'Repo:\s+\K[^\s]+' | head -1)

      if [ -z "$repository" ]; then
        echo "##vso[task.logissue type=error]Asset ${{ assetName }} not found in the dependency list"
        exit 1
      fi

      commit=$(echo "$dependencies" | grep -oP 'Commit:\s+\K[^\s]+' | head -1)

      echo "Updating the VMR from $repository / $commit..."
      cd ..
      git clone $repository $commit
      cd $commit
      git checkout $commit

      ./eng/vmr-sync.sh                         \
        --vmr ${{ parameters.vmrPath }}         \
        --tmp $(Agent.TempDirectory)            \
        --azdev-pat '$(dn-bot-all-orgs-code-r)' \
        --branch ${{ parameters.vmrBranch }}    \
        --ci                                    \
        --debug

      if [ "$?" -ne 0 ]; then
        echo "##vso[task.logissue type=error]Failed to synchronize the VMR"
        exit 1
      fi
    displayName: Synchronize dotnet/dotnet (Unix)
    condition: ne(variables['Agent.OS'], 'Windows_NT')
    workingDirectory: $(Agent.BuildDirectory)/sdk

  - powershell: |
      $ErrorActionPreference = 'Stop'

      Write-Host "Searching for details of asset ${{ assetName }}..."

      $dependencies = .\.dotnet\dotnet darc get-dependencies --name '${{ assetName }}' --ci

      $repository = $dependencies | Select-String -Pattern 'Repo:\s+([^\s]+)' | Select-Object -First 1
      $repository -match 'Repo:\s+([^\s]+)' | Out-Null
      $repository = $matches[1]

      if ($repository -eq $null) {
          Write-Error "Asset ${{ assetName }} not found in the dependency list"
          exit 1
      }

      $commit = $dependencies | Select-String -Pattern 'Commit:\s+([^\s]+)' | Select-Object -First 1
      $commit -match 'Commit:\s+([^\s]+)' | Out-Null
      $commit = $matches[1]

      Write-Host "Updating the VMR from $repository / $commit..."
      cd ..
      git clone $repository $commit
      cd $commit
      git checkout $commit

      $(Agent.BuildDirectory)/sdk/eng/vmr-sync.ps1 `
        -vmr ${{ parameters.vmrPath }}             `
        -tmp $(Agent.TempDirectory)                `
        -azdevPat '$(dn-bot-all-orgs-code-r)'      `
        -branch ${{ parameters.vmrBranch }}        `
        -ci                                        `
        -debugOutput

      if ($LASTEXITCODE -ne 0) {
        echo "##vso[task.logissue type=error]Failed to synchronize the VMR"
        exit 1
      }
    displayName: Synchronize dotnet/dotnet (Windows)
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    workingDirectory: $(Agent.BuildDirectory)/sdk
