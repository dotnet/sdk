<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFrameworks>net9.0;$(CurrentTargetFramework)</TargetFrameworks>
  </PropertyGroup>

  <Target Name="ComputeAvailableDevices" Returns="@(Devices)" DependsOnTargets="ResolveFrameworkReferences">
    <!-- If SingleDevice property is set, return only one device -->
    <ItemGroup Condition="'$(NoDevices)' != 'true' and '$(SingleDevice)' == 'true'">
      <Devices Include="single-device" Description="Single Device" Type="Emulator" Status="Online" RuntimeIdentifier="$(NETCoreSdkRuntimeIdentifier)" />
    </ItemGroup>
    <!-- Otherwise return multiple devices based on target framework -->
    <ItemGroup Condition="'$(NoDevices)' != 'true' and '$(SingleDevice)' != 'true' and '$(TargetFramework)' != 'net9.0'">
      <Devices Include="test-device-1" Description="Test Device 1" Type="Emulator" Status="Online" RuntimeIdentifier="$(NETCoreSdkRuntimeIdentifier)" />
      <Devices Include="test-device-2" Description="Test Device 2" Type="Device" Status="Online" />
    </ItemGroup>
    <ItemGroup Condition="'$(NoDevices)' != 'true' and '$(SingleDevice)' != 'true' and '$(TargetFramework)' == 'net9.0'">
      <Devices Include="test-device-downlevel-1" Description="Test Device Downlevel 1" Type="Emulator" Status="Online" RuntimeIdentifier="$(NETCoreSdkRuntimeIdentifier)" />
      <Devices Include="test-device-downlevel-2" Description="Test Device Downlevel 2" Type="Simulator" Status="Booted" />
    </ItemGroup>
  </Target>

  <!-- Generate a file with Device and RuntimeIdentifier properties if they are set -->
  <Target Name="GenerateDeviceInfo" 
          BeforeTargets="CoreCompile" 
          Condition="'$(Device)' != ''">
    
    <PropertyGroup>
      <DeviceInfoFile>$(IntermediateOutputPath)DeviceInfo.cs</DeviceInfoFile>
    </PropertyGroup>
    
    <ItemGroup>
      <DeviceInfoLines Include="// &lt;auto-generated/&gt;" />
      <DeviceInfoLines Include="namespace DotNetRunDevices%3B" />
      <DeviceInfoLines Include=" " />
      <DeviceInfoLines Include="internal static class DeviceInfo" />
      <DeviceInfoLines Include="{" />
      <DeviceInfoLines Include="    public const string Device = &quot;$(Device)&quot;%3B" />
      <DeviceInfoLines Include="    public const string RuntimeIdentifier = &quot;$(RuntimeIdentifier)&quot;%3B" />
      <DeviceInfoLines Include="}" />
    </ItemGroup>
    
    <WriteLinesToFile File="$(DeviceInfoFile)" Lines="@(DeviceInfoLines)" Overwrite="true" />
    
    <ItemGroup>
      <Compile Include="$(DeviceInfoFile)" />
      <FileWrites Include="$(DeviceInfoFile)" />
    </ItemGroup>
  </Target>

  <!-- DeployToDevice target for testing, ResolveFrameworkReferences mimics Android -->
  <Target Name="DeployToDevice" DependsOnTargets="ResolveFrameworkReferences">
    <Message Text="DeployToDevice: Deployed to device $(Device) with RuntimeIdentifier $(RuntimeIdentifier)" Importance="high" />
  </Target>

</Project>
