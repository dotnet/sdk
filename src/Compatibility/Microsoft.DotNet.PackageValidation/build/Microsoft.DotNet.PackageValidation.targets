<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. -->
<Project>
  <UsingTask TaskName="Microsoft.DotNet.PackageValidation.ValidatePackage" AssemblyFile="$(DotNetPackageValidationAssembly)" />
  <UsingTask TaskName="Microsoft.DotNet.PackageValidation.GetLastStablePackage" AssemblyFile="$(DotNetPackageValidationAssembly)" />

  <ItemGroup Condition="'$(EnablePackageBaselineValidation)' == 'true' and '$(PackageValidationBaselinePath)' == '' and '$(PackageValidationBaselineVersion)' != ''">
    <PackageDownload Include="$(PackageId)" Version="[$(PackageValidationBaselineVersion)]" />
  </ItemGroup>

  <Target Name="RunPackageValidation"
          AfterTargets="Pack"
          Condition="$(IsPackable) == 'true'">

    <Error Condition="'$(EnablePackageBaselineValidation)' == 'true' and '$(PackageValidationBaselinePath)' == '' and '$(PackageValidationBaselineVersion)' == ''" Text="Please set PackageValidationBaselineVersion or PackageValidationBaselinePath property and restore the project again."/>

    <PropertyGroup >
      <PackageValidationBaselinePath Condition="'$(PackageValidationBaselinePath)' == '' and '$(PackageValidationBaselineVersion)' != ''">$([MSBuild]::NormalizePath('$(NuGetPackageRoot)', '$(PackageId.ToLower())', '$(PackageValidationBaselineVersion)', '$(PackageId.ToLower()).$(PackageValidationBaselineVersion).nupkg'))</PackageValidationBaselinePath>
    </PropertyGroup>

    <Error Condition="'$(EnablePackageBaselineValidation)' == 'true' and !Exists('$(PackageValidationBaselinePath)')" Text="$(PackageValidationBaselinePath) does not exist. Please check the PackageValidationBaselinePath or PackageValidationBaselineVersion." />

    <!-- PackageTargetPath isn't exposed by NuGet: https://github.com/NuGet/Home/issues/6671. -->
    <Microsoft.DotNet.PackageValidation.ValidatePackage
      PackageTargetPath="$([MSBuild]::ValueOrDefault('$(PackageTargetPath)', '$(PackageOutputPath)$(PackageId).$(PackageVersion).nupkg'))"
      RuntimeGraph="$(RuntimeIdentifierGraphPath)"
      NoWarn="$(NoWarn)"
      RunApiCompat="$([MSBuild]::ValueOrDefault('$(RunApiCompat)', 'true'))"
      BaselineValidation="$(EnablePackageBaselineValidation)"
      BaselinePackageTargetPath="$(PackageValidationBaselinePath)" />
  </Target>
</Project>
