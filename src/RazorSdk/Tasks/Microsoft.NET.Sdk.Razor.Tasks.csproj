<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <BlazorWasmSdkRoot>$(RepoRoot)\src\RazorSdk\</BlazorWasmSdkRoot>
    <PackageId>Microsoft.NET.Sdk.Razor</PackageId>
    <OutDirName>$(Configuration)\Sdks\$(PackageId)\tools</OutDirName>
    <AutoGenerateBindingRedirects>true</AutoGenerateBindingRedirects>

  </PropertyGroup>

  <PropertyGroup>
    <Description>SDK for building and publishing Blazor WebAssembly applications.</Description>
    <OutputType>Library</OutputType>
    <RootNamespace>Microsoft.NET.Sdk.BlazorWebAssembly</RootNamespace>
    <TargetFrameworks>$(SdkTargetFramework)</TargetFrameworks>
  </PropertyGroup>

  <PropertyGroup>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
    <EnableDefaultItems>false</EnableDefaultItems>
    <GenerateDependencyFile>false</GenerateDependencyFile>
    <IncludeBuildOutput>false</IncludeBuildOutput>

    <NoPackageAnalysis>true</NoPackageAnalysis>
    <!-- MSBuild Task DLLs need to be versioned with every build -->
    <AutoGenerateAssemblyVersion>true</AutoGenerateAssemblyVersion>
  </PropertyGroup>

  <PropertyGroup>
    <OutputPath>$(BaseOutputPath)</OutputPath>
    <IsPackable>true</IsPackable>
    <PackageLayoutOutputPath>$(ArtifactsBinDir)$(Configuration)\Sdks\$(PackageId)\</PackageLayoutOutputPath>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <PackageReference>
      <PrivateAssets>All</PrivateAssets>
      <Publish>true</Publish>
    </PackageReference>
  </ItemDefinitionGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Build.Framework" Version="15.8.166" ExcludeAssets="Runtime" />
    <PackageReference Include="Microsoft.Build.Utilities.Core" Version="15.8.166" ExcludeAssets="Runtime" />
    <PackageReference Include="System.Reflection.Metadata" Version="$(SystemReflectionMetadataVersion)" Condition="'$(TargetFramework)'=='net46'" />
    <PackageReference Include="Moq" Version="4.8.2" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="../Tool/Microsoft.NET.Sdk.Razor.Tool.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Reference Include="$(ArtifactsBinDir)\Microsoft.NET.Sdk.Razor.Tool\$(Configuration)\$(SdkTargetFramework)\rzc.dll"
      Targets="Publish"
      ReferenceOutputAssembly="false"
      SkipGetTargetFrameworkProperties="true"
      UndefineProperties="TargetFramework;TargetFrameworks;RuntimeIdentifier;PublishDir;SelfContained" />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="**\*.cs" />
    <Compile Include="..\Tool\ServerProtocol\*.cs">
      <Link>Shared\ServerProtocol\%(FileName)</Link>
    </Compile>
    <Compile Include="..\Tool\PipeName.cs">
      <Link>Shared\PipeName.cs</Link>
    </Compile>
    <Compile Include="..\Tool\MutexName.cs">
      <Link>Shared\MutexName.cs</Link>
    </Compile>
    <Compile Include="..\Tool\Client.cs">
      <Link>Shared\Client.cs</Link>
    </Compile>
  </ItemGroup>

    <Target Name="CopyAdditionalFilesToLayout" Condition="'$(TargetFramework)' == ''" AfterTargets="Build" Inputs="@(LayoutFile)" Outputs="@(LayoutFile-&gt;'$(PackageLayoutOutputPath)%(TargetPath)')">
    <Copy SourceFiles="@(LayoutFile)" DestinationFiles="@(LayoutFile-&gt;'$(PackageLayoutOutputPath)%(TargetPath)')">
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites" />
    </Copy>
  </Target>

  <Target Name="PackLayout" DependsOnTargets="CopyAdditionalFilesToLayout" BeforeTargets="$(GenerateNuspecDependsOn)">
    <ItemGroup>
      <Content Include="$(PackageLayoutOutputPath)**\*" PackagePath="\" />
    </ItemGroup>
  </Target>

</Project>
