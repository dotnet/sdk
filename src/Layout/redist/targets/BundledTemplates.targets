<Project>

  <!-- Set TemplateFrameworkVersion to a different value than '$(MajorMinorVersion)' during rebranding. -->
  <PropertyGroup>
    <TemplateFrameworkVersion>$(MajorMinorVersion)</TemplateFrameworkVersion>
  </PropertyGroup>

  <ItemGroup>
    <BundledTemplate Include="Microsoft.DotNet.Web.ItemTemplates.11.0" PackageVersion="$(MicrosoftDotNetWebItemTemplates110PackageVersion)" />
    <BundledTemplate Include="Microsoft.DotNet.Web.ProjectTemplates.11.0" PackageVersion="$(MicrosoftDotNetWebProjectTemplates110PackageVersion)" UseVersionForTemplateInstallPath="true" />
    <BundledTemplate Include="Microsoft.Dotnet.WinForms.ProjectTemplates" PackageVersion="$(MicrosoftDotnetWinFormsProjectTemplatesPackageVersion)" />
    <BundledTemplate Include="Microsoft.Dotnet.Wpf.ProjectTemplates" PackageVersion="$(MicrosoftDotnetWpfProjectTemplatesPackageVersion)" />
  </ItemGroup>

  <ItemGroup>
    <BundledTemplate Update="@(BundledTemplate)"
      TemplateFrameworkVersion="$(TemplateFrameworkVersion)"
      NupkgPathRelativeToPackageRoot="%(Identity)/%(PackageVersion)/%(Identity).%(PackageVersion).nupkg" />
    <BundledTemplate Update="@(BundledTemplate)"
      RestoredNupkgPath="$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(NupkgPathRelativeToPackageRoot)', '').ToLowerInvariant())" />
  </ItemGroup>

  <!-- Restore bundled templates -->
  <ItemGroup>
    <PackageDownload Include="@(BundledTemplate)" Version="[%(PackageVersion)]" />
  </ItemGroup>

  <Target Name="CalculateTemplatesVersions" DependsOnTargets="GetAssemblyVersion">
    <PropertyGroup>
      <!-- This number comes from arcade and combines the date based build number id and the revision (incremental number per day)
           Fallback to 0 when patch number is not set. This happens only during CI. -->
      <_ArcadePatchNumber>$([MSBuild]::ValueOrDefault('$(_PatchNumber)', '000000'))</_ArcadePatchNumber>
    </PropertyGroup>

    <CalculateTemplateVersions
      BundledTemplates="@(BundledTemplate)"
      FullNugetVersion="$(FullNugetVersion)"
      ProductMonikerRid="$(ProductMonikerRid)"
      InstallerExtension="$(InstallerExtension)"
      CombinedBuildNumberAndRevision="$(_ArcadePatchNumber)">
      <Output TaskParameter="BundledTemplatesWithInstallPaths" ItemName="BundledTemplatesWithInstallPaths" />
      <Output TaskParameter="TemplatesComponents" ItemName="TemplatesComponents" />
    </CalculateTemplateVersions>

    <ItemGroup>
      <TemplatesComponents>
        <MSIInstallerFile>$(ArtifactsNonShippingPackagesDir)%(TemplatesComponents.TemplateBaseFilename)-$(FullNugetVersion)-$(ProductMonikerRid)$(InstallerExtension)</MSIInstallerFile>
      </TemplatesComponents>
    </ItemGroup>
  </Target>

  <Target Name="LayoutTemplates"
        DependsOnTargets="LayoutTemplatesForSDK;LayoutTemplatesForMSI" />

  <Target Name="GetRepoTemplates" DependsOnTargets="ResolveProjectReferences">
    <ItemGroup>
      <RepoTemplate Include="$(ArtifactsShippingPackagesDir)Microsoft.DotNet.Common.ItemTemplates.*.nupkg" Exclude="$(ArtifactsShippingPackagesDir)Microsoft.DotNet.Common.ItemTemplates.*.symbols.nupkg" />
      <RepoTemplate Include="$(ArtifactsShippingPackagesDir)Microsoft.DotNet.Common.ProjectTemplates.*.nupkg" Exclude="$(ArtifactsShippingPackagesDir)Microsoft.DotNet.Common.ProjectTemplates.*.symbols.nupkg" />
    </ItemGroup>
  </Target>

  <Target Name="LayoutTemplatesForSDK" DependsOnTargets="CalculateTemplatesVersions;GetRepoTemplates">
    <Copy SourceFiles="%(BundledTemplatesWithInstallPaths.RestoredNupkgPath)"
          DestinationFolder="$(RedistInstallerLayoutPath)templates\%(BundledTemplatesWithInstallPaths.BundledTemplateInstallPath)" />

    <!-- Copy the current Microsoft.DotNet.Common.ItemTemplates and Microsoft.DotNet.Common.ProjectTemplates packages to the layout location. -->
    <PropertyGroup>
      <CurrentTemplateInstallPath>%(BundledTemplatesWithInstallPaths.BundledTemplateInstallPath)</CurrentTemplateInstallPath>
    </PropertyGroup>

    <Copy SourceFiles="@(RepoTemplate)"
          DestinationFiles="$(RedistInstallerLayoutPath)templates\$(CurrentTemplateInstallPath)\$([System.String]::Copy('%(Filename)%(Extension)').ToLowerInvariant())" />
  </Target>

  <Target Name="LayoutTemplatesForMSI" DependsOnTargets="CalculateTemplatesVersions;GetRepoTemplates" Condition="$(ProductMonikerRid.StartsWith('win'))">
    <Copy SourceFiles="%(BundledTemplatesWithInstallPaths.RestoredNupkgPath)"
          DestinationFolder="$(IntermediateOutputPath)templates-%(BundledTemplatesWithInstallPaths.TemplateFrameworkVersion)\templates\%(BundledTemplatesWithInstallPaths.BundledTemplateInstallPath)" />

    <!-- Copy the current Microsoft.DotNet.Common.ItemTemplates and Microsoft.DotNet.Common.ProjectTemplates packages to the layout location. -->
    <PropertyGroup>
      <CurrentTemplateInstallPath>%(BundledTemplatesWithInstallPaths.BundledTemplateInstallPath)</CurrentTemplateInstallPath>
      <CurrentTemplateFrameworkVersion>%(BundledTemplate.TemplateFrameworkVersion)</CurrentTemplateFrameworkVersion>
    </PropertyGroup>
    <Copy SourceFiles="@(RepoTemplate)"
          DestinationFiles="$(IntermediateOutputPath)templates-$(CurrentTemplateFrameworkVersion)\templates\$(CurrentTemplateInstallPath)\$([System.String]::Copy('%(Filename)%(Extension)').ToLowerInvariant())" />
  </Target>

</Project>
