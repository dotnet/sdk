<Project>

  <Target Name="OverlaySdkOnLKG" AfterTargets="Build" DependsOnTargets="GenerateInstallerLayout">
    <PropertyGroup>
      <RedistLayoutPath>$(ArtifactsBinDir)redist\$(Configuration)\dotnet\</RedistLayoutPath>
    </PropertyGroup>

    <PropertyGroup>
      <_DotNetHiveRoot>$(DOTNET_INSTALL_DIR)</_DotNetHiveRoot>
      <_DotNetHiveRoot Condition="'$(_DotNetHiveRoot)' == ''">$(RepoRoot).dotnet/</_DotNetHiveRoot>
      <_DotNetHiveRoot Condition="!HasTrailingSlash('$(_DotNetHiveRoot)')">$(_DotNetHiveRoot)/</_DotNetHiveRoot>
    </PropertyGroup>

    <!-- Ignore the sdk and templates directories which should only contain the live built artifacts. -->
    <ItemGroup>
      <OverlaySDKFile Include="$(_DotNetHiveRoot)/**/*"
                      Exclude="$(_DotNetHiveRoot)sdk/**/*;
                               $(_DotNetHiveRoot)templates/**/*"/>
    </ItemGroup>

    <!-- Copy artifacts from the stage0 SDK folder. -->
    <Copy SourceFiles="@(OverlaySDKFile)"
          DestinationFiles="@(OverlaySDKFile->'$(RedistLayoutPath)%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true"/>

    <ItemGroup>
      <InstallerOutputFile Include="$(RedistInstallerLayoutPath)**\*" />
    </ItemGroup>

    <!-- Copy the live built SDK folder. -->
    <Copy SourceFiles="@(InstallerOutputFile)"
          DestinationFiles="@(InstallerOutputFile->'$(RedistLayoutPath)%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />

    <!-- Run "dotnet new" (which will just display usage and available templates) in order to print first time
         use message so that it doesn't interfere with tests which check the output of commands. -->
    <Exec Command="$(RedistLayoutPath)dotnet new"
          EnvironmentVariables="DOTNET_CLI_HOME=$(ArtifactsTmpDir)" />
  </Target>

</Project>
