<Project>

  <Target Name="OverlaySdkOnLKG" AfterTargets="Build" DependsOnTargets="GenerateInstallerLayout">
    <PropertyGroup>
      <TestHostFolder>$(ArtifactsBinDir)redist\$(Configuration)\dotnet\</TestHostFolder>
    </PropertyGroup>

    <PropertyGroup>
      <_DotNetHiveRoot>$(DOTNET_INSTALL_DIR)</_DotNetHiveRoot>
      <_DotNetHiveRoot Condition="'$(_DotNetHiveRoot)' == ''">$(RepoRoot).dotnet/</_DotNetHiveRoot>
      <_DotNetHiveRoot Condition="!HasTrailingSlash('$(_DotNetHiveRoot)')">$(_DotNetHiveRoot)/</_DotNetHiveRoot>
    </PropertyGroup>

    <!-- Copy artifacts from the stage0 SDK folder.
         Ignore the sdk and templates directories which should only contain the live built artifacts. -->
    <ItemGroup>
      <_OverlaySDKFile Include="$(_DotNetHiveRoot)\**\*"
                       Exclude="$(_DotNetHiveRoot)sdk\**\*;
                                $(_DotNetHiveRoot)templates\**\*"/>
      <OverlaySDKFile Include="@(_OverlaySDKFile->'$(TestHostFolder)%(RecursiveDir)%(Filename)%(Extension)')" Source="%(Identity)" />
    </ItemGroup>

    <ItemGroup>
      <_InstallerOutputFile Include="$(RedistInstallerLayoutPath)**\*" />
      <InstallerOutputFile Include="@(_InstallerOutputFile->'$(TestHostFolder)%(RecursiveDir)%(Filename)%(Extension)')" Source="%(Identity)" />
      <InstallerOutputFile Include="@(OverlaySDKFile)" Exclude="@(InstallerOutputFile)" />
    </ItemGroup>

    <!-- Copy artifacts to the testhost folder. -->
    <Copy DestinationFiles="@(InstallerOutputFile)"
          SourceFiles="@(InstallerOutputFile->Metadata('Source'))"
          SkipUnchangedFiles="true" />

    <!-- Run "dotnet new" (which will just display usage and available templates) in order to print first time
         use message so that it doesn't interfere with tests which check the output of commands. -->
    <Exec Command="$(TestHostFolder)$([System.IO.Path]::GetFileName('$(DotNetTool)')) new"
          EnvironmentVariables="DOTNET_CLI_HOME=$(ArtifactsTmpDir)" />
  </Target>

</Project>
