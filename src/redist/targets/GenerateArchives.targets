<Project>
    <!-- Disable the GenerateArchives step in the local dev build, only do when -pack is specified to speed up dev builds -->
  <Target Name="GenerateArchives"
          Condition="'$(PackInstaller)' == 'true'"
          DependsOnTargets="GenerateLayout;GetCurrentRuntimeInformation"
          BeforeTargets="AfterBuild">

    <!-- When running in Docker under a Windows host, tar is warning "file changed as we read it" for several files and returning exit code 1.
         So this flag allows that to be ignored. -->
    <PropertyGroup Condition="'$(IgnoreTarExitCode)' == ''">
      <IgnoreTarExitCode>false</IgnoreTarExitCode>
      <IgnoreTarExitCode Condition="'$(DOTNET_CORESDK_IGNORE_TAR_EXIT_CODE)' == '1'">true</IgnoreTarExitCode>
    </PropertyGroup>

    <!-- Ensure output directories are created -->
    <MakeDir Directories="$(ArtifactsShippingPackagesDir);$(ArtifactsNonShippingPackagesDir)" />

    <!-- Create .tar.gz files on Linux/MacOS, and .zip files on Windows -->
    <ZipFileCreateFromDirectory
        Condition=" '$(OSName)' == 'win' "
        SourceDirectory="$(RedistLayoutPath)"
        DestinationArchive="$(ArtifactsShippingPackagesDir)$(ArtifactNameWithVersionCombinedHostHostFxrFrameworkSdk).zip"
        OverwriteDestination="true" />

    <ZipFileCreateFromDirectory
        Condition=" '$(OSName)' == 'win' "
        SourceDirectory="$(SdkInternalLayoutPath)"
        DestinationArchive="$(ArtifactsNonShippingPackagesDir)$(ArtifactNameWithVersionSdk).zip"
        OverwriteDestination="true" />

    <TarGzFileCreateFromDirectory
        Condition=" '$(OSName)' != 'win' "
        SourceDirectory="$(RedistLayoutPath)"
        DestinationArchive="$(ArtifactsShippingPackagesDir)$(ArtifactNameWithVersionCombinedHostHostFxrFrameworkSdk).tar.gz"
        OverwriteDestination="true"
        IgnoreExitCode="$(IgnoreTarExitCode)"/>

    <TarGzFileCreateFromDirectory
        Condition=" '$(OSName)' != 'win' and '$(DotNetBuildFromSource)' != 'true'"
        SourceDirectory="$(SdkInternalLayoutPath)"
        DestinationArchive="$(ArtifactsNonShippingPackagesDir)$(ArtifactNameWithVersionSdk).tar.gz"
        OverwriteDestination="true"
        IgnoreExitCode="$(IgnoreTarExitCode)"/>
    
  </Target>
</Project>
