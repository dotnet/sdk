<Project>

  <ItemGroup Condition=" '$(IncludeAspNetCoreRuntime)' != 'false' ">
    <BundledDotnetTool Include="dotnet-dev-certs" Version="$(DotnetDevCertsPackageVersion)" />
    <BundledDotnetTool Include="dotnet-user-jwts" Version="$(DotnetUserJwtsPackageVersion)" />
    <BundledDotnetTool Include="dotnet-user-secrets" Version="$(DotnetUserSecretsPackageVersion)" ObsoletesCliTool="Microsoft.Extensions.SecretManager.Tools" />
  </ItemGroup>

  <ItemGroup>
    <BundledDotnetTool Update="@(BundledDotnetTool)">
      <PackagePathRelativeToPackageRoot>%(Identity)/%(Version)/</PackagePathRelativeToPackageRoot>
      <RestoredPackagePath>$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(PackagePathRelativeToPackageRoot)', '').ToLower())/</RestoredPackagePath>
      <NupkgPathRelativeToPackageRoot>%(Identity)/%(Version)/%(Identity).%(Version).nupkg</NupkgPathRelativeToPackageRoot>
      <RestoredNupkgPath>$(NuGetPackageRoot)$([MSBuild]::ValueOrDefault('%(NupkgPathRelativeToPackageRoot)', '').ToLower())</RestoredNupkgPath>
    </BundledDotnetTool>
  </ItemGroup>

  <Target Name="LayoutBundledTools" DependsOnTargets="SetupBundledComponents">
    <PropertyGroup>
      <PackageToRestore>%(BundledDotnetTool.Identity)</PackageToRestore>
      <PackageVersionToRestore>%(BundledDotnetTool.Version)</PackageVersionToRestore>
      <RestoredToolRoot>$([System.IO.Path]::GetFullPath('$(NuGetPackageRoot)/$(PackageToRestore)/$(PackageVersionToRestore)'))</RestoredToolRoot>
    </PropertyGroup>

    <ItemGroup>
      <BundledToolLayoutProject Include="$(MSBuildThisFileDirectory)DownloadPackage.csproj">
        <!-- For this unique RestoreProjectStyle, see: https://aka.ms/global-tools-nuget -->
        <Properties>
          PackageToRestore=$(PackageToRestore);
          PackageVersionToRestore=$(PackageVersionToRestore);
          TargetFramework=$(TargetFramework);
          RestoreProjectStyle=DotnetToolReference
        </Properties>
      </BundledToolLayoutProject>
    </ItemGroup>

    <MSBuild BuildInParallel="False" Projects="@(BundledToolLayoutProject)" />

    <ItemGroup>
      <BundledToolFiles Include="$(RestoredToolRoot)\**\*.*" />
      <BundledToolFiles Remove="$(RestoredToolRoot)\*.*" />
    </ItemGroup>

    <Copy SourceFiles="@(BundledToolFiles)"
          DestinationFiles="@(BundledToolFiles->'$(SdkOutputDirectory)DotnetTools/$(PackageToRestore)\$(PackageVersionToRestore)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true"
          Condition="'$(PackageToRestore)' != ''" />
  </Target>

</Project>
