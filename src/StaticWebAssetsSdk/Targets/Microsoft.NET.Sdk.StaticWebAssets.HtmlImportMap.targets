<!--
***********************************************************************************************
Microsoft.NET.Sdk.StaticWebAssets.HtmlImportMap.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved.
***********************************************************************************************
-->

<Project ToolsVersion="14.0">
    
  <UsingTask TaskName="Microsoft.AspNetCore.StaticWebAssets.Tasks.WriteImportMapToHtml" AssemblyFile="$(StaticWebAssetsSdkBuildTasksAssembly)" />

  <PropertyGroup>
    <ResolveBuildRelatedStaticWebAssetsDependsOn>
      $(ResolveBuildRelatedStaticWebAssetsDependsOn);
      _UpdateHtmlFiles;
    </ResolveBuildRelatedStaticWebAssetsDependsOn>
    <ResolveCompressedFilesDependsOn>
      $(ResolveCompressedFilesDependsOn);
      _UpdateHtmlFiles
    </ResolveCompressedFilesDependsOn>
  </PropertyGroup>

  <Target Name="_UpdateHtmlFiles">
    <PropertyGroup>
      <_BuildImportMapHtmlPath>$([MSBuild]::NormalizeDirectory($(IntermediateOutputPath), 'importmaphtml', 'build'))</_BuildImportMapHtmlPath>
    </PropertyGroup>

    <MakeDir Directories="$(_BuildImportMapHtmlPath)"/>

    <!-- Find HTML Static Web Assets -->
    <ItemGroup>
      <_HtmlStaticWebAssets Include="@(StaticWebAsset)" Condition="'%(AssetKind)' != 'Publish' and '%(Extension)' == '.html'" />
      <_EsModuleCandidate Include="@(StaticWebAsset)" Condition="'%(AssetKind)' != 'Publish'" />
    </ItemGroup>

    <!-- Filter relevant endpoints, write import map and fingerprinted assets to html files -->
    <FilterStaticWebAssetEndpoints Condition="'@(_EsModuleCandidate)' != ''"
      Endpoints="@(StaticWebAssetEndpoint)"
      Assets="@(_EsModuleCandidate)"
      Filters=""
    >
      <Output TaskParameter="FilteredEndpoints" ItemName="_EsModuleCandidateEndpoints" />
    </FilterStaticWebAssetEndpoints>
    <WriteImportMapToHtml
      Endpoints="@(_EsModuleCandidateEndpoints)"
      HtmlFiles="@(_HtmlStaticWebAssets)"
      OutputPath="$(_BuildImportMapHtmlPath)">
      <Output TaskParameter="HtmlCandidates" ItemName="_HtmlCandidates" />
      <Output TaskParameter="HtmlFilesToRemove" ItemName="_HtmlFilesToRemove" />
      <Output TaskParameter="FileWrites" ItemName="FileWrites" />
    </WriteImportMapToHtml>

    <!-- Replace modified HTML swa -->
    <ItemGroup>
      <_HtmlCandidatesNoMetadata
        Include="@(_HtmlCandidates)"
        RemoveMetadata="SourceType;AssetKind;Integrity;Fingerprint" />
      <_HtmlCandidatesNoMetadata ContentRoot="$(_BuildImportMapHtmlPath)" />
    </ItemGroup>
    <DefineStaticWebAssets CandidateAssets="@(_HtmlCandidatesNoMetadata)"
      SourceType="Computed"
      AssetKind="Build"
    >
      <Output TaskParameter="Assets" ItemName="_UpdatedHtmlStaticWebAssets" />
    </DefineStaticWebAssets>
    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_UpdatedHtmlStaticWebAssets)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_UpdatedHtmlStaticWebAssetsEndpoint" />
    </DefineStaticWebAssetEndpoints>
    <ItemGroup>
      <StaticWebAsset Remove="@(_HtmlFilesToRemove)" />
      <StaticWebAsset Include="@(_UpdatedHtmlStaticWebAssets)" />
      <StaticWebAssetEndpoint Include="@(_UpdatedHtmlStaticWebAssetsEndpoint)" />
    </ItemGroup>
  </Target>
  
  <!-- Publish -->
  <PropertyGroup>
    <ResolvePublishRelatedStaticWebAssetsDependsOn>
      $(ResolvePublishRelatedStaticWebAssetsDependsOn);
      _UpdatePublishHtmlFiles;
    </ResolvePublishRelatedStaticWebAssetsDependsOn>
  </PropertyGroup>

  <Target Name="_UpdatePublishHtmlFiles">
    <PropertyGroup>
      <_PublishImportMapHtmlPath>$([MSBuild]::NormalizeDirectory($(IntermediateOutputPath), 'importmaphtml', 'publish'))</_PublishImportMapHtmlPath>
    </PropertyGroup>

    <MakeDir Directories="$(_PublishImportMapHtmlPath)"/>

    <ItemGroup>
      <_EsModuleCandidateForPublish Include="@(StaticWebAsset)" Condition="'%(AssetKind)' != 'Build'" />
    </ItemGroup>

    <!-- Filter relevant endpoints, write import map and fingerprinted assets to html files -->
    <FilterStaticWebAssetEndpoints Condition="'@(_EsModuleCandidateForPublish)' != ''"
      Endpoints="@(StaticWebAssetEndpoint)"
      Assets="@(_EsModuleCandidateForPublish)"
      Filters=""
    >
      <Output TaskParameter="FilteredEndpoints" ItemName="_EsModuleCandidateForPublishEndpoints" />
    </FilterStaticWebAssetEndpoints>
    <WriteImportMapToHtml
      Endpoints="@(_EsModuleCandidateForPublishEndpoints)"
      HtmlFiles="@(_HtmlStaticWebAssets)"
      OutputPath="$(_PublishImportMapHtmlPath)">
      <Output TaskParameter="HtmlCandidates" ItemName="_HtmlPublishCandidates" />
      <Output TaskParameter="HtmlFilesToRemove" ItemName="_HtmlPublishFilesToRemove" />
      <Output TaskParameter="FileWrites" ItemName="FileWrites" />
    </WriteImportMapToHtml>

    <!-- Replace modified HTML swa -->
    <ItemGroup>
      <_HtmlPublishCandidatesNoMetadata
        Include="@(_HtmlPublishCandidates)"
        RemoveMetadata="SourceType;AssetKind;Integrity;Fingerprint" />
      <_HtmlPublishCandidatesNoMetadata ContentRoot="$(_PublishImportMapHtmlPath)" />
    </ItemGroup>
    <DefineStaticWebAssets CandidateAssets="@(_HtmlPublishCandidatesNoMetadata)"
      SourceType="Computed"
      AssetKind="Publish"
    >
      <Output TaskParameter="Assets" ItemName="_UpdatedHtmlPublishStaticWebAssets" />
    </DefineStaticWebAssets>
    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_UpdatedHtmlPublishStaticWebAssets)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_UpdatedHtmlPublishStaticWebAssetsEndpoint" />
    </DefineStaticWebAssetEndpoints>
    <ItemGroup>
      <StaticWebAsset Remove="@(_HtmlPublishFilesToRemove)" />
      <StaticWebAsset Include="@(_UpdatedHtmlPublishStaticWebAssets)" />
      <StaticWebAssetEndpoint Include="@(_UpdatedHtmlPublishStaticWebAssetsEndpoint)" />
    </ItemGroup>
  </Target>

</Project>