<!--
***********************************************************************************************
Sdk.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved.
***********************************************************************************************
-->
<Project ToolsVersion="14.0">
  <!-- For browser-wasm, we want to import StaticWebAssets SDK which imports SDK. -->
  <!-- For wasi-wasm, we don't want to import StaticWebAssets SDK. -->
  <Import Sdk="Microsoft.NET.Sdk.StaticWebAssets" Project="Sdk.targets" Condition="'$(RuntimeIdentifier)' != 'wasi-wasm' and '$(_WasmSdkImportsMicrosoftNETSdkStaticWebAssets)' == 'true'" />
  <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.targets" Condition="'$(RuntimeIdentifier)' == 'wasi-wasm' and '$(_WasmSdkImportsMicrosoftNetSdk)' == 'true'" />

  <PropertyGroup>
    <_WasmEnableHotReload>$(WasmEnableHotReload)</_WasmEnableHotReload>
    <_WasmEnableHotReload Condition="'$(_WasmEnableHotReload)' == '' and '$(Configuration)' != 'Debug'">false</_WasmEnableHotReload>
    <_WasmEnableHotReload Condition="'$(_WasmEnableHotReload)' == '' and '$(TargetFrameworkIdentifier)' == '.NETCoreApp' and $([MSBuild]::VersionGreaterThanOrEquals('$(TargetFrameworkVersion)', '10.0'))">true</_WasmEnableHotReload>
  </PropertyGroup>
  <Target Name="_WasmImplicitlyReferenceHotReload" BeforeTargets="ResolveProjectStaticWebAssets" AfterTargets="ResolveStaticWebAssetsConfiguration" Condition="'$(_WasmEnableHotReload)' == 'true'">
    <PropertyGroup>
      <_WasmHotReloadTfm Condition="$([MSBuild]::VersionGreaterThanOrEquals('$(TargetFrameworkVersion)', '10.0'))">net10.0</_WasmHotReloadTfm>
      <_WasmHotReloadPath Condition="'$(_WasmHotReloadTfm)' != ''">$([MSBuild]::NormalizeDirectory($(MSBuildThisFileDirectory), '..', 'hotreload', $(_WasmHotReloadTfm)))</_WasmHotReloadPath>
      <_WasmHotReloadIntermediatePath>$(IntermediateOutputPath)hotreload\</_WasmHotReloadIntermediatePath>
    </PropertyGroup>

    <!-- Copy the JS module to intermediate folder to avoid duplicate identity when multiple projects reference the same SDK file -->
    <Copy
      SourceFiles="$(_WasmHotReloadPath)wwwroot\Microsoft.DotNet.HotReload.WebAssembly.Browser.lib.module.js"
      DestinationFolder="$(_WasmHotReloadIntermediatePath)"
      SkipUnchangedFiles="true"
      Condition="'$(_WasmHotReloadPath)' != ''" />

    <ItemGroup Condition="'$(_WasmHotReloadPath)' != ''">
      <ReferenceCopyLocalPaths Include="$(_WasmHotReloadPath)Microsoft.DotNet.HotReload.WebAssembly.Browser.dll">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <CopyToPublishDirectory>Never</CopyToPublishDirectory>
      </ReferenceCopyLocalPaths>
      <_WasmHotReloadModule Include="$(_WasmHotReloadIntermediatePath)Microsoft.DotNet.HotReload.WebAssembly.Browser.lib.module.js">
        <RelativePath>_framework/Microsoft.DotNet.HotReload.WebAssembly.Browser.lib.module.js</RelativePath>
      </_WasmHotReloadModule>
      <_WasmHotReloadModule Update="@(_WasmHotReloadModule)">
        <OriginalItemSpec>%(Identity)</OriginalItemSpec>
      </_WasmHotReloadModule>
      <FileWrites Include="$(_WasmHotReloadIntermediatePath)Microsoft.DotNet.HotReload.WebAssembly.Browser.lib.module.js" />
    </ItemGroup>

    <DefineStaticWebAssets
      CandidateAssets="@(_WasmHotReloadModule)"
      FingerprintCandidates="$(StaticWebAssetsFingerprintContent)"
      FingerprintPatterns="@(StaticWebAssetFingerprintPattern)"
      SourceId="$(PackageId)"
      SourceType="Computed"
      ContentRoot="$(_WasmHotReloadIntermediatePath)"
      BasePath="$(StaticWebAssetBasePath)"
      AssetKind="Build"
      AssetTraitName="JSModule"
      AssetTraitValue="JSLibraryModule"
      PropertyOverrides="AssetTraitName;AssetTraitValue"
      Condition="'$(_WasmHotReloadPath)' != ''">
        <Output TaskParameter="Assets" ItemName="StaticWebAsset" />
        <Output TaskParameter="Assets" ItemName="_WasmHotReloadModuleStaticWebAsset" />
    </DefineStaticWebAssets>
    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_WasmHotReloadModuleStaticWebAsset)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
      Condition="'$(_WasmHotReloadPath)' != ''">
      <Output TaskParameter="Endpoints" ItemName="StaticWebAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>
  </Target>

  <Import Sdk="Microsoft.NET.Sdk.Publish" Project="Sdk.targets" Condition="'$(_WasmSdkImportsMicrosoftNETSdkPublish)' == 'true'" />
  <Import Project="$(_WebAssemblyTargetsFile)" Condition="'$(_WebAssemblyTargetsFile)' != ''" />
</Project>
