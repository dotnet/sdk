<Project>

  <UsingTask TaskName="Microsoft.NET.Sdk.WebAssembly.PatchWasmPublishStaticWebAsset" AssemblyFile="$(StaticWebAssetsSdkBuildTasksAssembly)" Condition="'$(StaticWebAssetsSdkBuildTasksAssembly)' != ''" />

  <PropertyGroup>
    <AddWasmStaticWebAssetsDependsOn>
      $(AddWasmStaticWebAssetsDependsOn);
      _GenerateBuildWasmBootJson;
    </AddWasmStaticWebAssetsDependsOn>
  </PropertyGroup>

  <Target Name="ForceBootConfigGeneration" BeforeTargets="_AddPublishWasmBootJsonToStaticWebAssets" DependsOnTargets="GeneratePublishWasmBootJson" />

  <!-- Generate blazor.boot.json with the correct assets and update fingerprint and integrity -->
  <Target Name="_DefineWasmBuildEndpoints" AfterTargets="_GenerateBuildWasmBootJson" DependsOnTargets="ResolveCoreStaticWebAssets">

    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_BuildWasmBootJsonStaticWebAsset)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_BuildWasmBootJsonStaticWebAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(WasmStaticWebAsset)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="WasmStaticWebAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAssetEndpoint Include="@(_BuildWasmBootJsonStaticWebAssetEndpoint)" />
      <StaticWebAssetEndpoint Include="@(WasmStaticWebAssetEndpoint)" />
    </ItemGroup>
  </Target>

  <Target Name="_CorrectPublishFilesIntegrity" AfterTargets="ProcessPublishFilesForWasm">
    <ItemGroup>
      <_PublishFilesToCorrectIntegrity Include="@(_NewWebCilPublishStaticWebAssets)" RemoveMetadata="Integrity;Fingerprint" />
    </ItemGroup>

    <PatchWasmPublishStaticWebAsset StaticWebAssets="@(_NewWasmPublishStaticWebAssets)">
      <Output TaskParameter="AssetsToRemove" ItemName="_WasmIncorrectAssetsToRemove" />
    </PatchWasmPublishStaticWebAsset>

    <ItemGroup>
      <_PublishFilesToCorrectIntegrity Remove="@(_WasmIncorrectAssetsToRemove)" />
    </ItemGroup>

    <DefineStaticWebAssets
      CandidateAssets="@(_PublishFilesToCorrectIntegrity)"
    >
      <Output TaskParameter="Assets" ItemName="_NewPublishFilesToCorrectIntegrity" />
    </DefineStaticWebAssets>

    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_NewPublishFilesToCorrectIntegrity)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_NewPublishFilesToCorrectIntegrityEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAsset Remove="@(_NewWebCilPublishStaticWebAssets)" />
      <StaticWebAsset Include="@(_NewPublishFilesToCorrectIntegrity)" />
      <StaticWebAssetEndpoint Include="@(_NewPublishFilesToCorrectIntegrityEndpoint)" />
    </ItemGroup>
  </Target>

  <Target Name="_DefineEndpointsForWasmExtensions" AfterTargets="ComputeWasmExtensions">
    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_BlazorExtensionsCandidatesForPublish)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_WasmExtensionStaticWebAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAssetEndpoint Include="@(_WasmExtensionStaticWebAssetEndpoint)" />
    </ItemGroup>
  </Target>

  <Target Name="_DefinePublishBootJsonEndpoint" AfterTargets="_AddPublishWasmBootJsonToStaticWebAssets">
    <PropertyGroup>
      <_PublishWasmBootJsonPath>@(_PublishWasmBootJson->'%(FullPath)')</_PublishWasmBootJsonPath>
    </PropertyGroup>
    <ItemGroup>
      <_PublishWasmBootJsonAsset
        Include="@(StaticWebAsset)"
        Condition="'%(StaticWebAsset.Identity)' == '$(_PublishWasmBootJsonPath)'" />
    </ItemGroup>

    <DefineStaticWebAssetEndpoints
      CandidateAssets="@(_PublishWasmBootJsonAsset)"
      ExistingEndpoints="@(StaticWebAssetEndpoint)"
      ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
    >
      <Output TaskParameter="Endpoints" ItemName="_PublishWasmBootJsonAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAssetEndpoint Include="@(_PublishWasmBootJsonAssetEndpoint)" />
    </ItemGroup>

  </Target>

</Project>
